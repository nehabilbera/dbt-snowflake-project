CREATE WAREHOUSE TRANSFORMING;
CREATE DATABASE RAW;
CREATE DATABASE ANALYTICS;
CREATE SCHEMA RAW.JAFFLE_SHOP;
CREATE SCHEMA RAW.STRIPE;

CREATE OR REPLACE TABLE RAW.JAFFLE_SHOP.CUSTOMERS(
    ID INTEGER,
    FIRST_NAME VARCHAR,
    LAST_NAME VARCHAR
);

create OR REPLACE table raw.jaffle_shop.orders
( id integer,
  user_id integer,
  order_date date,
  status varchar,
  _etl_loaded_at timestamp default current_timestamp
);

create OR REPLACE table raw.stripe.payment 
( id integer,
  orderid integer,
  paymentmethod varchar,
  status varchar,
  amount integer,
  created date,
  _batched_at timestamp default current_timestamp
);


CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE='csv'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
NULL_IF = ('NULL', 'null');

CREATE OR REPLACE STORAGE INTEGRATION S3_INT
TYPE = EXTERNAL_STAGE
STORAGE_PROVIDER = S3
ENABLED = TRUE
STORAGE_AWS_ROLE_ARN = '<role-arn>'
STORAGE_ALLOWED_LOCATIONS = ('<file-url>');

DESC INTEGRATION S3_INT;



CREATE OR REPLACE STAGE dbt_files
URL = '<file-url>'
STORAGE_INTEGRATION = S3_INT
FILE_FORMAT = CSV_FORMAT;

list @dbt_files;

CREATE OR REPLACE PIPE ORDERS_PIPE
AUTO_INGEST = TRUE
AS COPY INTO RAW.JAFFLE_SHOP.ORDERS
(
  ID,
  USER_ID,
  ORDER_DATE,
  STATUS
)
FROM @dbt_files
PATTERN='.*orders.*\\.csv';

CREATE OR REPLACE PIPE PAYMENTS_PIPE
AUTO_INGEST = TRUE
AS COPY INTO RAW.STRIPE_PAYMENTS
(
  ID,
  ORDERID,
  PAYMENTMETHOD,
  STATUS,
  AMOUNT,
  CREATED
)
FROM @dbt_files
PATTERN='.*payments.*\\.csv';

CREATE OR REPLACE PIPE CUSTOMERS_PIPE
AUTO_INGEST = TRUE
AS COPY INTO RAW.CUSTOMERS
(
  ID,
  FIRST_NAME,
  LAST_NAME
)
FROM @dbt_files
PATTERN='.*customers.*\\.csv';


LIST @dbt_files;
DESC PIPE ORDERS_PIPE;
DESC PIPE PAYMENTS_PIPE;
DESC PIPE CUSTOMERS_PIPE;

ALTER PIPE ORDERS_PIPE REFRESH;
ALTER PIPE PAYMENTS_PIPE REFRESH;
ALTER PIPE CUSTOMERS_PIPE REFRESH;

SELECT SYSTEM$PIPE_STATUS('ORDERS_PIPE');
SELECT SYSTEM$PIPE_STATUS('PAYMENTS_PIPE');
SELECT SYSTEM$PIPE_STATUS('CUSTOMERS_PIPE');

LIST @dbt_files;

select * from raw.jaffle_shop.customers; 

select * from raw.jaffle_shop.orders; 
delete from raw.jaffle_shop.orders where id=1001; 

select * from raw.stripe.payment;

select * from raw.jaffle_shop.dim_customers;

select * from RAW.JAFFLE_SHOP.FACT_ORDERS;
delete from RAW.JAFFLE_SHOP.FACT_ORDERS where NEHA='Neha';

-- MACROS

select * from RAW.JAFFLE_SHOP.CUSTOM_MACRO_CHECK;

select * from RAW.JAFFLE_SHOP.INBUILT_MACRO _CHECK;



-- SNAPSHOT
CREATE OR REPLACE TABLE SAMPLE_TABLE(
    ID INT,
    NAME VARCHAR(234),
    UPDATE_AT_TIME TIMESTAMP
);

INSERT INTO SAMPLE_TABLE (ID, NAME, UPDATE_AT_TIME) VALUES
    (1, 'A', '2024-01-01 10:00:00'),
    (2, 'B', '2024-02-15 15:30:45'),
    (3, 'C', '2024-03-20 08:15:10');

SELECT * FROM SAMPLE_TABLE;

SELECT * FROM RAW.STRIPE.SAMPLE_SNAP;

UPDATE RAW.STRIPE.SAMPLE_TABLE
SET NAME = 'A-Updated',
    UPDATE_AT_TIME = CURRENT_TIMESTAMP()
WHERE ID = 1; 

UPDATE RAW.STRIPE.SAMPLE_TABLE
SET NAME = 'A-Updated-Again',
    UPDATE_AT_TIME = CURRENT_TIMESTAMP()
WHERE ID = 1; 


CREATE OR REPLACE TABLE SAMPLE_TAB(
    ID INT,
    NAME VARCHAR(234)
);

INSERT INTO SAMPLE_TAB (ID, NAME) VALUES
    (1, 'A'),
    (2, 'B'),
    (3, 'C');

SELECT * FROM SAMPLE_TAB;
SELECT * FROM SAMPLE_SNAP2;

UPDATE RAW.STRIPE.SAMPLE_TAB
SET NAME = 'A-Updated'
WHERE ID = 1; 


drop table RAW.JAFFLE_SHOP.DIM_CUSTOMERS;
drop table RAW.JAFFLE_SHOP.FACT_ORDERS;
drop view RAW.JAFFLE_SHOP.CUSTOM_MACRO_CHECK;
drop view RAW.JAFFLE_SHOP.INBUILT_MACRO_CHECK;
drop view RAW.JAFFLE_SHOP.STG_JAFFLE_SHOP_CUSTOMERS;
drop view RAW.JAFFLE_SHOP.STG_JAFFLE_SHOP_ORDERS;
drop view RAW.JAFFLE_SHOP.STG_STRIPE_PAYMENTS;